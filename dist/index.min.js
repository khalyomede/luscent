!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).luscent={})}(this,(function(e){"use strict";var t=function(){return t=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},t.apply(this,arguments)};function n(e,t,n,o){return new(n||(n=Promise))((function(r,a){function u(e){try{i(o.next(e))}catch(e){a(e)}}function c(e){try{i(o.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,c)}i((o=o.apply(e,t||[])).next())}))}function o(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},u=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return u.next=c(0),u.throw=c(1),u.return=c(2),"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function c(c){return function(i){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;u&&(u=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,i])}}}var r=function(e,t){void 0===t&&(t=null);for(var n=[],o=document.evaluate(e,null!=t?t:document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),r=0;r<o.snapshotLength;r++){var a=o.snapshotItem(r);null!==a&&a instanceof HTMLElement&&n.push(a)}return n},a=function(e,t,a,u){var c;console.debug("binding events"),console.debug("target is",u);for(var i=function(e){console.debug("Found element matching data-luscent-on",e);var r=Object.keys(e.dataset);if(r.some((function(e){return e.endsWith("Bind")})))return"continue";var u=null!==(c=r.filter((function(e){return e.startsWith("luscentOn")}))[0])&&void 0!==c?c:"",i=u.replace("luscentOn","").toLowerCase(),s=e.dataset[u],l="luscentOn".concat(i.charAt(0).toUpperCase()+i.slice(1),"Bound");if("true"===e.dataset[l])return"continue";s&&a[s]&&(console.log("binding event to element",{eventName:i,methodName:s,node:e}),e.addEventListener(i,(function(r){return n(void 0,void 0,void 0,(function(){var n;return o(this,(function(o){switch(o.label){case 0:return"submit"===i&&r.preventDefault(),n=e.dataset.luscentForId,[4,a[s](t.state,r,n)];case 1:return o.sent(),[2]}}))}))}),{passive:"submit"!==i,capture:!0}),e.dataset[l]="true")},s=0,l=r('//*[./@*[starts-with(name(), "data-luscent-on-")]]',u);s<l.length;s++){i(l[s])}},u=function(e,t,r,a){var u=function(e){var u=a.querySelector("[data-luscent-bind=".concat(e,"]"));if(!(u instanceof HTMLElement))return"continue";var c=u.dataset.luscentBindOn;return void 0===c?"continue":u instanceof HTMLInputElement?void 0!==u.dataset.luscentBound?"continue":(u.addEventListener(c,(function(a){return n(void 0,void 0,void 0,(function(){var n,u,c;return o(this,(function(o){switch(o.label){case 0:return a.target instanceof HTMLInputElement?(n=a.target.value,(c={})[e]=n,u=c,[4,d(t,t.state,u,r,[document])]):[2];case 1:return o.sent(),[2]}}))}))})),void(u.dataset.luscentBound=String(!0))):"continue"};for(var c in e)u(c)},c=function(e,n){void 0===n&&(n=document);var o=t(t({},e.added),e.updated),r={domUpdates:[],elementsToRender:[]},a=new Map,u=function(e){console.debug("Computing state key",e);var t=o[e],u=n.querySelector("[data-luscent-value=".concat(e,"]"));u instanceof HTMLElement&&r.domUpdates.push((function(){return u.textContent=t}));var c=n.querySelector("[data-luscent-with=".concat(e,"]"));if(c instanceof HTMLElement){var i=c.dataset.luscentAttribute;void 0!==i&&r.domUpdates.push((function(){return c.setAttribute(i,t)}))}var s=n.querySelector("[data-luscent-if=".concat(e,"]"));if((console.debug("Trying to find element with [data-luscent-if=".concat(e,"]"),s),s instanceof HTMLElement)&&(console.debug("Found data-luscent-if element"),void 0!==(d=s.dataset.luscentTemplate))){var l=n.querySelector("#".concat(d));l instanceof HTMLTemplateElement&&(r.domUpdates.push((function(){return s.textContent=""})),t&&(r.domUpdates.push((function(){return s.appendChild(l.content.cloneNode(!0))})),r.elementsToRender.push(s)))}if(Array.isArray(t)){var d,f=n.querySelector("[data-luscent-for=".concat(e,"]"));if(f instanceof HTMLElement)if(void 0!==(d=f.dataset.luscentTemplate)){var p=function(e,t){if(t.has(e))return console.debug("template cache hit",e),t.get(e);var n=document.querySelector("[data-luscent-template=".concat(e,"]"));return n instanceof HTMLTemplateElement?(t.set(e,n),n):void 0}(d,a);if(void 0!==p){var v=f.dataset.luscentKey;if(void 0!==v){var h=null;console.debug("Iterating on values for data-luscent-for=".concat(e),t);for(var m=function(t){if("object"==typeof t){var o=t[v],a=n.querySelector("[data-luscent-rendered-for-key=".concat(e,".").concat(v,"][data-luscent-rendered-for-id=").concat(o,"]"));if(a instanceof HTMLElement)h=a;else{var u=p.content.cloneNode(!0);r.domUpdates.push(null!==h?function(){return null==h?void 0:h.after(u)}:function(){return f.append(u)}),r.elementsToRender.push(f)}}},b=0,y=t;b<y.length;b++){m(y[b])}}}}a=new Map}};for(var c in o)u(c);return r},i=function(e,t){var n={},o={},r={},a={};for(var u in console.log("before",e),console.log("after",t),e){var c=e[u];if(u in t){var i=t[u];c!=i&&(n[u]=i),typeof c!=typeof i&&(a[u]=i)}else r[u]=e[u]}for(var s in t)s in e||(o[s]=t[s]);return{added:o,updated:n,deleted:r,mutated:a}},s=function(e){return new Promise((function(t){return requestAnimationFrame((function(){return requestAnimationFrame((function(){e.forEach((function(e){return e()})),t()}))}))}))},l=function(e,t,r,d,f){return n(void 0,void 0,Promise,(function(){var n,p,v,h,m,b,y,g,T,w,E;return o(this,(function(o){switch(o.label){case 0:for(n=i(t,r),console.log("diff",n),p=[],v=[],h=0,m=f;h<m.length;h++)E=m[h],b=c(n,E),y=b.domUpdates,g=b.elementsToRender,p.push.apply(p,y),v.push.apply(v,g);return[4,s(p)];case 1:for(o.sent(),T=0,w=f;T<w.length;T++)E=w[T],a(r,e,d,E),u(r,e,d,E);return v.length>0?[4,l(e,t,r,d,v)]:[3,3];case 2:o.sent(),o.label=3;case 3:return[2]}}))}))},d=l,f=function(e){var r=e.state||{},a=e.methods||{},u=(e.getters,e.conditions,e.lists,{state:r});return d(u,{},u.state,a,[document]),console.log("Luscent app started successfully"),{updateState:function(e){return n(void 0,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,d(u,u.state,e,a,[document])];case 1:return n.sent(),u.state=t(t({},u.state),e),[2]}}))}))}}};e.start=f}));