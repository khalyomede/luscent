!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).luscent={})}(this,(function(e){"use strict";var t=function(){return t=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},t.apply(this,arguments)};function n(e,t,n,o){return new(n||(n=Promise))((function(r,a){function c(e){try{i(o.next(e))}catch(e){a(e)}}function u(e){try{i(o.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,u)}i((o=o.apply(e,t||[])).next())}))}function o(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function u(u){return function(i){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,u[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&u[0]?o.return:u[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,u[1])).done)return r;switch(o=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,o=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){a.label=u[1];break}if(6===u[0]&&a.label<r[1]){a.label=r[1],r=u;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(u);break}r[2]&&a.ops.pop(),a.trys.pop();continue}u=t.call(e,a)}catch(e){u=[6,e],o=0}finally{n=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,i])}}}var r=function(e,t,r,a){for(var c=function(e){if(!(e instanceof HTMLElement))return"continue";var a=e.dataset.luscentTrigger;if(void 0===a||!(a in r))return"continue";var c=e.dataset.luscentOn;if(void 0===c)return"continue";var u=e.dataset.luscentPreventDefault;e.addEventListener(c,(function(c){return n(void 0,void 0,void 0,(function(){var n;return o(this,(function(o){switch(o.label){case 0:return void 0!==u&&c.preventDefault(),n=e.dataset.luscentRenderedId,[4,r[a](t.state,c,n)];case 1:return o.sent(),[2]}}))}))}),{passive:void 0===u,capture:!0}),e.dataset.luscentBound=String(!0)},u=0,i=Array.from(document.querySelectorAll("[data-luscent-on][data-luscent-trigger]:not([data-luscent-bound])"));u<i.length;u++){c(i[u])}},a=function(e,t,r,a){var c=function(e){var c=a.querySelector("[data-luscent-bind=".concat(e,"]"));if(!(c instanceof HTMLElement))return"continue";var u=c.dataset.luscentBindOn;return void 0===u?"continue":c instanceof HTMLInputElement?void 0!==c.dataset.luscentBound?"continue":(c.addEventListener(u,(function(a){return n(void 0,void 0,void 0,(function(){var n,c,u;return o(this,(function(o){switch(o.label){case 0:return console.log("two way triggering..."),a.target instanceof HTMLInputElement?(n=a.target.value,(u={})[e]=n,c=u,[4,l(t,t.state,c,r,[document])]):[2];case 1:return o.sent(),[2]}}))}))})),void(c.dataset.luscentBound=String(!0))):"continue"};for(var u in e)c(u)},c=function(e,n){void 0===n&&(n=document);var o=t(t({},e.added),e.updated),r={domUpdates:[],elementsToRender:new Map},a=new Map,c=function(e){console.debug("Computing state key",e);var t=o[e];console.debug("----- data-luscent-value");var c=n.querySelector("[data-luscent-value=".concat(e,"]"));c instanceof HTMLElement&&r.domUpdates.push((function(){return c.textContent=t})),console.debug("----- data-luscent-id");var u=n.querySelector("[data-luscent-id=".concat(e,"]"));u instanceof HTMLElement&&(u.dataset.luscentRenderedId=t),console.debug("----- data-luscent-bind");var i=n.querySelector("[data-luscent-bind=".concat(e,"]"));i instanceof HTMLInputElement&&r.domUpdates.push((function(){return i.value=t})),console.debug("----- data-luscent-attribute");var s=n.querySelector("[data-luscent-with=".concat(e,"]"));if(s instanceof HTMLElement){var l=s.dataset.luscentAttribute;void 0!==l&&r.domUpdates.push((function(){return s.setAttribute(l,t)}))}console.debug("----- data-luscent-if");var d=n.querySelector("[data-luscent-if=".concat(e,"]"));if((console.debug("Trying to find element with [data-luscent-if=".concat(e,"]"),d),d instanceof HTMLElement)&&(console.debug("Found data-luscent-if element"),void 0!==(v=d.dataset.luscentTemplate))){var f=n.querySelector("template#".concat(v));f instanceof HTMLTemplateElement&&(r.domUpdates.push((function(){return d.textContent=""})),t&&(r.domUpdates.push((function(){return d.appendChild(f.content.cloneNode(!0))})),r.elementsToRender.set(d,o)))}if(console.debug("----- data-luscent-for"),Array.isArray(t)){var p=n.querySelector("[data-luscent-for=".concat(e,"]"));if(console.debug("Finding element with data-luscent-for=".concat(e)),p instanceof HTMLElement){var v=p.dataset.luscentTemplate;if(console.debug("Finding template with id=".concat(v)),void 0!==v){var h=function(e,t){if(t.has(e))return console.debug("template cache hit",e),t.get(e);var n=document.querySelector("template#".concat(e));return console.debug("Search for template with id ".concat(e," (uncached)Ì€")),n instanceof HTMLTemplateElement?(t.set(e,n),console.debug("warming cache"),n):void 0}(v,a);if(void 0!==h){console.debug("Found template");var m=p.dataset.luscentKey;if(void 0!==m){var g=null;console.debug("Iterating on values for data-luscent-for=".concat(e),t);for(var b=function(t){if(console.debug("rendering item",t),"object"==typeof t){var o=t[m],a=n.querySelector('[data-luscent-rendered-for-key="'.concat(e,".").concat(m,'"][data-luscent-rendered-for-id="').concat(o,'"]'));if(a instanceof HTMLElement)g=a;else{for(var c=h.content.cloneNode(!0),u=0,i=Array.from(c.childNodes);u<i.length;u++){var s=i[u];s instanceof HTMLElement&&(console.debug("---- child is",s),s.dataset.luscentRenderedForKey="".concat(e,".").concat(m),s.dataset.luscentRenderedForId=o,r.elementsToRender.set(s,t))}null!==g?r.domUpdates.push((function(){return null==g?void 0:g.after(c)})):r.domUpdates.push((function(){return p.append(c)}))}}},y=0,w=t;y<w.length;y++){b(w[y])}}}}}a=new Map}};for(var u in o)c(u);return r},u=function(e,t){var n={},o={},r={},a={};for(var c in console.log("before",e),console.log("after",t),e){var u=e[c];if(c in t){var i=t[c];u!=i&&(n[c]=i),typeof u!=typeof i&&(a[c]=i)}else r[c]=e[c]}for(var s in t)s in e||(o[s]=t[s]);return{added:o,updated:n,deleted:r,mutated:a}},i=function(e){return new Promise((function(t){return requestAnimationFrame((function(){return requestAnimationFrame((function(){e.forEach((function(e){return e()})),t()}))}))}))},s=function(e,l,d,f,p){for(var v=[],h=5;h<arguments.length;h++)v[h-5]=arguments[h];return n(void 0,function(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}([e,l,d,f,p],v,!0),Promise,(function(e,n,l,d,f,p){var v,h,m,g,b,y,w,T,E,M,S,L;return void 0===p&&(p=!0),o(this,(function(o){switch(o.label){case 0:for(console.log("----- rendering start",f),v=u(n,l),console.log("diff",v),h=[],m=new Map,g=0,b=f;g<b.length;g++)L=b[g],y=c(v,L),w=y.domUpdates,T=y.elementsToRender,h.push.apply(h,w),T.forEach((function(e,t){return m.set(t,e)}));return[4,i(h)];case 1:return o.sent(),m.size>0?(console.debug("new elements to render"),m.forEach((function(e,t){return console.debug(t)})),E=[],m.forEach((function(t,n){return E.push(s(e,{},t,d,[n]))})),[4,Promise.all(E)]):[3,3];case 2:o.sent(),o.label=3;case 3:for(M=0,S=f;M<S.length;M++)L=S[M],r(l,e,d,L),a(l,e,d,L);return p&&(e.state=t(t({},e.state),l)),[2]}}))}))},l=s,d=function(e){var r=e.state||{},a=e.methods||{},c=e.onStateChanged,u={state:r};return l(u,{},u.state,a,[document]),console.log("Luscent app started successfully"),{updateState:function(e){return n(void 0,void 0,void 0,(function(){var n,r;return o(this,(function(o){switch(o.label){case 0:return n=c(t(t({},u.state),e)),r=t(t(t({},u.state),e),n),[4,l(u,u.state,r,a,[document])];case 1:return o.sent(),[2]}}))}))}}};e.start=d}));